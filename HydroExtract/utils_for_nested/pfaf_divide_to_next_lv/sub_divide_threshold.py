# coding=utf-8
import random


# 验证需要划分次级流域的数量阈值: 原始面积数组 总面积 拟划分的前n个多边形的n值 次级划分的个数 当前层级与次级层级的倍数(默认为4倍) 方差(返回) 平均面积(返回) 阈值标识(返回)
def divide_area_threshold(area_array, total_area, n, divide_num, mul=3):
    # 需要划分的前n个流域的面积数组
    divide_areas = []
    # 剩余的面积数组
    remain_areas = area_array[:]
    for d in range(n):
        divide_areas.append(remain_areas[0])
        del remain_areas[0]
    # 划分出的新流域集
    n_basins = []
    for to_d_area in divide_areas:
        d_area = to_d_area / divide_num
        for a in range(divide_num):
            n_basins.append(d_area)
    # 划分后的总流域集
    new_areas = remain_areas[:]
    new_areas.extend(n_basins)
    # 划分后的流域总数
    total_num = len(new_areas)
    # 平均面积
    avg_area = total_area / total_num

    # 计算方差
    up_part = 0
    for area in new_areas:
        up_part = up_part + (area - avg_area) ** 2
    variance = up_part / total_num

    # 原平均面积
    old_avg_area = total_area / len(area_array)
    # 若达到次级数据集的要求(默认平均面积为上一级的1/3)
    if avg_area < old_avg_area / mul:
        print('current avg of area: ', old_avg_area)
        print('new theoretic num of sub basins: ', total_num)
        print('new avg of area: ', avg_area)
        return variance, avg_area, 1
    else:
        return variance, avg_area, 0


# 根据流域多边形面积集合给出需要次级划分的流域: 流域多边形信息集合 流域次级划分的个数 要划分的多边形集合(返回)
def get_basins_to_divide(basins_info, divide_num):

    # 初始总数
    o_num = len(basins_info)
    print('current num of basins: ', o_num)
    # 按值由大到小排序
    area_sort = sorted(basins_info.items(), key=lambda kv: (kv[1], kv[0]))
    area_sort.reverse()
    # 计算总面积
    total_area = 0
    # 获得已排序的面积数组
    areas_array = []
    for item in area_sort:
        area = item[1]
        total_area = total_area + area
        areas_array.append(area)

    # 初始化进行次级划分的数量
    to_sub_num = 1

    variances = []
    avg_areas = []
    for no_num in range(1, o_num):
        variance, avg_area, flag = divide_area_threshold(areas_array, total_area, no_num, divide_num)
        variances.append(variance)
        avg_areas.append(avg_area)
        if flag:
            to_sub_num = no_num
            break

    # # 记录方差
    # variances_record = workspace + '\\variances.txt'
    # with open(variances_record, 'w') as t:
    #     variances_str_array = [str(j) for j in variances]
    #     variances_str = ','.join(variances_str_array)
    #     t.write(variances_str)
    # # 记录平均面积
    # areas_record = workspace + '\\avg_areas.txt'
    # with open(areas_record, 'w') as t:
    #     areas_str_array = [str(j) for j in avg_areas]
    #     areas_str = ','.join(areas_str_array)
    #     t.write(areas_str)

    # 得到需要划分的流域其标识
    to_divide = []
    for basin_order in range(to_sub_num):
        basin_id = area_sort[basin_order][0]
        to_divide.append(basin_id)

    print('num of basins to divide / total num: ', len(to_divide), '/', o_num)

    return to_divide


if __name__ == '__main__':
    workspace = r'G:\Graduation\Program\Data\47\0'
    # test_areas = []
    # for i in range(201):
    #     test_areas.append(random.randint(10, 10000))
    # original_areas_record = workspace + '\\p_areas.txt'
    # with open(original_areas_record, 'w') as f:
    #     areas_str_array = [str(i) for i in test_areas]
    #     areas_str = ','.join(areas_str_array)
    #     f.write(areas_str)
    # original_info = {}
    # for i in range(len(test_areas)):
    #     index = str(i)
    #     original_info[index] = test_areas[i]
    # print(original_info)
    original_info = {'0': 42219.7, '1': 4887.2, '2': 8725.4, '3': 11947.9, '4': 67795, '5': 4491.6, '6': 1140.6,
                     '7': 8510.8, '8': 9202.9, '9': 2971.3, '10': 19228.5, '11': 31207, '12': 20388.8, '13': 40846.2,
                     '14': 42681, '15': 21274.8, '16': 54846.8, '17': 48402.3, '18': 14967.5, '19': 6824.8,
                     '20': 17362.5, '21': 128700.4, '22': 83.5, '23': 232.9, '24': 4716, '25': 211.2, '26': 815.3,
                     '27': 5544.4, '28': 233.6, '29': 53151.3, '30': 40813.1, '31': 19957.2, '32': 60621.2, '33': 258.4,
                     '34': 15993.7, '35': 6989.6, '36': 19131.3, '37': 340.7, '38': 14606.9, '39': 20348.6,
                     '40': 13709.5, '41': 42538.3, '42': 83879.4, '43': 46486.3, '44': 45411.8, '45': 27227.7,
                     '46': 22371.7, '47': 48968.3, '48': 16091.2, '49': 35713.7, '50': 15879.7, '51': 5880.7,
                     '52': 29917.3, '53': 43518.5, '54': 76429.7, '55': 33155.9, '56': 199.6, '57': 3350.9, '58': 39.1,
                     '59': 16000.4, '60': 4806.5, '61': 98200, '62': 351, '63': 26460.4, '64': 35264.3, '65': 13067.4,
                     '66': 106691.3, '67': 256.2, '68': 886.6, '69': 1570.1, '70': 948.6, '71': 951.2, '72': 171732.7,
                     '73': 376.7, '74': 561.6, '75': 1358.3, '76': 9903.8, '77': 557.7, '78': 3480.9, '79': 5122.8,
                     '80': 968, '81': 2137.9, '82': 39095.3, '83': 28035, '84': 41.8, '85': 7199.4, '86': 48441.6,
                     '87': 33079.6, '88': 56158, '89': 63682.1, '90': 637.8, '91': 26467.5, '92': 8100.2, '93': 24648.3,
                     '94': 25598.1, '95': 3658.3, '96': 9566.6, '97': 12060.9, '98': 27956.1, '99': 175386.7,
                     '100': 79016.5, '101': 32183.7, '102': 80130.4, '103': 88694.4, '104': 111719.6, '105': 12697.3,
                     '106': 5811.8, '107': 6716.7, '108': 51068.2, '109': 39855.4, '110': 1801.4, '111': 4.1,
                     '112': 1187.9, '113': 3, '114': 1720.9, '115': 172.2, '116': 14263.2, '117': 62002.9,
                     '118': 8860.7, '119': 16836.7, '120': 11390.8, '121': 9397.9, '122': 32198.9, '123': 12186.6,
                     '124': 9988.1, '125': 4688.4, '126': 8622.5, '127': 51776.6, '128': 23118, '129': 11190.7,
                     '130': 9635.2, '131': 5660.8, '132': 6151.2, '133': 1746.2, '134': 6240.2, '135': 6083.8,
                     '136': 17747.2, '137': 48217.5, '138': 73671.3, '139': 51089.2, '140': 77969.7, '141': 8288.7,
                     '142': 7587.7, '143': 1722, '144': 47927.1, '145': 19749.6, '146': 8637.6, '147': 8981.4,
                     '148': 53454.5, '149': 19026, '150': 23538.1, '151': 95695.6, '152': 4907.6, '153': 10068.9,
                     '154': 57990.4, '155': 15723.5, '156': 15622, '157': 14238, '158': 12021.8, '159': 51813.4,
                     '160': 849.7, '161': 15978.9, '162': 1060.1, '163': 19014.8, '164': 16042.5, '165': 8018.8,
                     '166': 10909.2, '167': 10764.8, '168': 15895.6, '169': 6872.2, '170': 12501.6, '171': 19100.5,
                     '172': 54522.9, '173': 30280, '174': 11228.8, '175': 914.8, '176': 7674.2, '177': 32468.8,
                     '178': 10416.2, '179': 31031, '180': 77474.5, '181': 5853.9, '182': 15334.7, '183': 5777.8,
                     '184': 17973.1, '185': 45961.8, '186': 44026.7, '187': 4545.9, '188': 32657.3, '189': 6512.4,
                     '190': 1790, '191': 32.9, '192': 10309.6, '193': 47148, '194': 2739.4, '195': 3836.1,
                     '196': 12601.2, '197': 20589.6, '198': 8738.4, '199': 43.5, '200': 49405.8, '201': 4751.1,
                     '202': 40549.1, '203': 2139.3, '204': 25531.9, '205': 8031.4, '206': 63660.7, '207': 26957.6,
                     '208': 4654, '209': 9431.2, '210': 1699.3, '211': 74314.2, '212': 7944.9, '213': 3440.4,
                     '214': 11789.2, '215': 6511.6, '216': 10646.2, '217': 23350.6, '218': 9463.9, '219': 5226.7,
                     '220': 50839.6, '221': 22654.3, '222': 7567.3, '223': 2423.4, '224': 17337.4, '225': 8626.2,
                     '226': 16772.9, '227': 14751.2, '228': 33211.9, '229': 48500.1, '230': 22150.2, '231': 32233.6,
                     '232': 21294.4, '233': 2011.3, '234': 20989.6, '235': 28478.2, '236': 15086.1, '237': 67981.2,
                     '238': 13227.4, '239': 18307.8, '240': 873.8, '241': 98847.8, '242': 5093.1, '243': 78634.9,
                     '244': 279.3, '245': 50540.7, '246': 266.9, '247': 6893.9, '248': 113432, '249': 21024,
                     '250': 76643.4, '251': 20319.1, '252': 53422.7, '253': 17351.1, '254': 3741.6, '255': 4.8,
                     '256': 15576, '257': 32195.7, '258': 13781, '259': 35156.6, '260': 95584.8, '261': 56306.4,
                     '262': 9542.6, '263': 27668.8, '264': 39118.3, '265': 48669.5, '266': 15906.6, '267': 27747,
                     '268': 5460.8, '269': 2102.7, '270': 3976.1, '271': 10505.3, '272': 2079.9, '273': 1029.7,
                     '274': 2465.7, '275': 35142.1, '276': 2208.1, '277': 2251.5, '278': 4154.8, '279': 1690,
                     '280': 22795.6, '281': 1907, '282': 2377.3, '283': 39.3, '284': 2930.2, '285': 27691.4,
                     '286': 5011.7, '287': 5270.5, '288': 4123.4, '289': 23594.4, '290': 6956.6, '291': 5390.7,
                     '292': 351.7, '293': 45.2, '294': 7795, '295': 69153.7, '296': 253, '297': 29.4, '298': 51.6,
                     '299': 32.7, '300': 14.2, '301': 19706.9, '302': 19009, '303': 13641.4, '304': 7862.6, '305': 338,
                     '306': 27057.7, '307': 6409.3, '308': 54536.1, '309': 11928.1, '310': 9862.3, '311': 20311.7,
                     '312': 318.7, '313': 252.9, '314': 1911.3, '315': 6232.2, '316': 5848.4, '317': 130, '318': 3919.7,
                     '319': 3218.6, '320': 7114.4, '321': 12154.9, '322': 13798.2, '323': 600.4, '324': 63866.7,
                     '325': 369, '326': 33.9, '327': 980.2, '328': 55047.8, '329': 0.2, '330': 52005.3, '331': 141.9,
                     '332': 19208.6, '333': 580.9, '334': 41197.8, '335': 749.8, '336': 6194.5, '337': 2459.2,
                     '338': 5193.6, '339': 17154.5, '340': 20480.4, '341': 17240.7, '342': 5173.4, '343': 1954.1,
                     '344': 12761.6, '345': 17723.7, '346': 26770.9, '347': 12584.2, '348': 30559.9, '349': 11186.3,
                     '350': 25836.7, '351': 16876.9, '352': 5400.2, '353': 8018.4, '354': 27863.8, '355': 1451.4,
                     '356': 15724, '357': 17135, '358': 7407.5, '359': 18702.3, '360': 3237.7, '361': 25271.3,
                     '362': 33346.7, '363': 53564.2, '364': 95272.9, '365': 6625.5, '366': 9341.5, '367': 34628.4,
                     '368': 51614.6, '369': 78249.5, '370': 87902.1, '371': 64371.1, '372': 67244.8, '373': 80788.8,
                     '374': 161182.2, '375': 53170.1, '376': 52882.2, '377': 45837.2, '378': 47423.1, '379': 134656.4,
                     '380': 73779.3, '381': 39641.9, '382': 38807.6, '383': 65879, '384': 35898.1, '385': 33357.6,
                     '386': 464.8, '387': 64348.6, '388': 31076.7, '389': 30186.5, '390': 27499.2, '391': 42892,
                     '392': 89261.1, '393': 25921.7, '394': 25654.4, '395': 22725.7, '396': 19611, '397': 98577.9,
                     '398': 17067.6, '399': 16956.8, '400': 15776, '401': 80717.2, '402': 14987.6, '403': 23011.7,
                     '404': 50967.7, '405': 14036, '406': 13961.1, '407': 13925.2, '408': 13736.7, '409': 16501.4,
                     '410': 18707.4, '411': 18529.2, '412': 11835.8, '413': 11630, '414': 11254.9, '415': 83025.1,
                     '416': 10273.4, '417': 87105, '418': 9883.2, '419': 38921.6, '420': 9697.1, '421': 31126.7,
                     '422': 52169.7, '423': 21366.4, '424': 32333.8, '425': 8423.2, '426': 8977.1, '427': 12394,
                     '428': 20918.9, '429': 81473.9, '430': 92283.7, '431': 11758.8, '432': 11095.3, '433': 13679.8,
                     '434': 7601.3, '435': 10219.1, '436': 13739.4, '437': 17375.1, '438': 18658.2, '439': 6350.6,
                     '440': 11891.2, '441': 18468.7, '442': 5499.9, '443': 23867.2, '444': 19323.3, '445': 8910.7,
                     '446': 12982.1, '447': 14209, '448': 10188.7, '449': 6520.9, '450': 5293.1, '451': 4881.1,
                     '452': 6983.8, '453': 3434.3, '454': 5784.3, '455': 14119.7, '456': 16188.8, '457': 10182.4,
                     '458': 8800.5, '459': 3714.9, '460': 5505.2, '461': 14652.4, '462': 4044.7, '463': 8713.8,
                     '464': 3141.4, '465': 3587.9, '466': 3631.6, '467': 1534.3, '468': 2811.4, '469': 6842.4,
                     '470': 2419, '471': 6770.2, '472': 3565.1}
    to_divide_indexes = get_basins_to_divide(original_info, 9)
